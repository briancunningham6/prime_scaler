name: Elixir CI/CD Release Pipeline
on:
  push:
    branches: [ prod ]
  pull_request:
    branches: [ prod ]
jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    
    env:
      MIX_ENV: prod
      
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Elixir
      uses: erlef/setup-beam@v1
      with:
        elixir-version: '1.15.4'
        otp-version: '26.0'
    
    - name: Restore dependencies cache
      uses: actions/cache@v3
      with:
        path: |
          deps
          _build
        key: ${{ runner.os }}-mix-${{ hashFiles('**/mix.lock') }}
        restore-keys: ${{ runner.os }}-mix-
    
    - name: Install dependencies
      run: mix deps.get
    
    - name: Compile
      run: mix compile
      
    - name: Run tests
      run: |
        MIX_ENV=test mix test
        
    - name: Install frontend dependencies
      run: |
        cd assets
        npm ci
        
    - name: Build assets
      run: |
        mix assets.deploy
        
    - name: Create release
      run: |
        mix phx.gen.release
        mix release --overwrite
        
    - name: Package release
      run: |
        mkdir -p releases
        VERSION=$(grep 'version:' mix.exs | sed -E 's/.*version: "([^"]+)".*/\1/')
        RELEASE_NAME="prime_scaler-${VERSION}.zip"
        zip -r "releases/${RELEASE_NAME}" _build/prod/rel/prime_scaler
        echo "RELEASE_NAME=${RELEASE_NAME}" >> $GITHUB_ENV
        echo "RELEASE_VERSION=${VERSION}" >> $GITHUB_ENV
        
    - name: Upload release artifact
      uses: actions/upload-artifact@v4
      with:
        name: release-build
        path: releases/*.zip
        retention-days: 5
        
  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/prod'
    
    steps:
    - name: Download artifact
      uses: actions/download-artifact@v4
      with:
        name: release-build
        path: releases
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: release-${{ github.run_number }}
        name: Release ${{ github.run_number }}
        files: releases/*.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}